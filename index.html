<!doctype html>
<html lang="en">
  <head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Are we animated yet?</title>
  </head>
  <body role="document">

    <div class="container">
      <h1>Are we animated yet?</h1>
      <p>This page tracks the progress of implementing the <a
      href="http://w3c.github.io/web-animations/">Web Animations API</a>
      in Firefox. The status here refers to the status in the latest <a
      href="https://nightly.mozilla.org/">Firefox Nightly build</a>.
      In Firefox Developer Edition (aka Aurora) you'll see bits and pieces of
      the API, and in beta and release versions you'll see nothing at all
      unless you set <code>dom.animations-api.core.enabled</code> to true.</p>
      <p><a class="btn btn-primary btn-lg"
        href="https://nightly.mozilla.org/" role="button">Firefox
        Nightly &raquo;</a></p>
    </div>
    <div class="container" id="interfaces"></div>
  </body>
  <script src="js/vendor/react.js"></script>
  <script src="js/vendor/JSXTransformer.js"></script>
  <script src="js/vendor/zepto.min.js"></script>
  <script type="text/jsx">
    var BugTracker = function() {
      var pendingBugs = [];
      var loadedBugs = [];

      return {
        fetch: function() {
          var ids = Object.keys(pendingBugs).map(Number).join(',');
          var query = 'https://bugzilla.mozilla.org/rest/bug?id=' + ids
                      + '&include_fields=id,summary,status,resolution'
                      + ',last_change_time';
          var xhr = $.getJSON(query);
          var self = this;

          xhr.then(function(response) {

            response.bugs.forEach(function(bug) {
              loadedBugs[bug.id] = bug;
              if (pendingBugs.hasOwnProperty(bug.id)) {
                pendingBugs[bug.id].forEach(function(deferred) {
                  deferred.resolve(bug);
                });
                delete pendingBugs[bug.id];
              }
            });

            for(id in pendingBugs) {
              pendingBugs[id].forEach(function(deferred) {
                deferred.reject('Bug not found');
              });
            }
            pendingBugs = [];
          }).fail(function(xhr, error) {
            for(id in pendingBugs) {
              pendingBugs[id].forEach(function(deferred) {
                deferred.reject(error);
              });
            }
          });

          return xhr;
        },

        getBug: function(id) {
          var deferred = $.Deferred();
          if (loadedBugs.hasOwnProperty(id)) {
            deferred.resolve(loadedBugs[id]);
          } else {
            if (pendingBugs.hasOwnProperty(id)) {
              pendingBugs[id].push(deferred);
            } else {
              pendingBugs[id] = [ deferred ];
            }
          }
          return deferred.promise();
        }
      };
    };
    var bugTracker = new BugTracker();

    var InterfaceBox = React.createClass({
      render: function() {
        var specLink =
          'http://w3c.github.io/web-animations/#'
          + this.props.name.toLowerCase();
        return (
          <div className="interface">
            <span className="interface-name"><a
              href={specLink}>{this.props.name}</a></span>
            {
              this.props.members.map(function(member) {
                return <Member key={member.name} {...member} />;
              })
            }
          </div>
        );
      }
    });

    var Member = React.createClass({
      render: function() {
        var specLink =
          [ 'http://w3c.github.io/web-animations/#dom',
            this.props.interface.toLowerCase(),
            this.props.name.toLowerCase() ].join('-');
        var detailsId =
          [ 'details',
            this.props.interface.toLowerCase(),
            this.props.name.toLowerCase() ].join('-');
        return (
          <div className={'member ' + this.props.status}><a
            href={'#' + detailsId}>{this.props.name}</a>
            {
              this.props.bugs.map(function(bugNum) {
                return <BugIcon key={'bug-icon-' + bugNum} id={bugNum} />;
              }.bind(this))
            }
            <MemberDetails {...this.props} specLink={specLink}
              id={detailsId}/>
          </div>
        );
      }
    });

    var MemberDetails = React.createClass({
      getInitialState: function() {
        return { open: false };
      },
      toggle: function() {
        this.setState({ open: !this.state.open });
      },
      render: function() {
        var classes = ['details'];
        if (this.state.open) {
          classes.push('open');
        }
        return (
          <div id={this.props.id} className={classes.join(' ')}>
            <a href={this.props.specLink} className="specLink"
              target="_new">Spec &raquo;</a>
            <ul className="bug-list">
              {
                this.props.bugs.map(function(bugNum) {
                  return <BugDetail key={'bug-detail-' + bugNum} id={bugNum} />;
                }.bind(this))
              }
            </ul>
          </div>
        );
      }
    });

    var BugInfoMixin = {
      getInitialState: function() {
        return { loadState: 'loading' };
      },
      componentWillMount: function() {
        bugTracker.getBug(this.props.id).then(function(bug) {
          this.setState($.extend({ loadState: 'load-complete' }, bug));
        }.bind(this)).fail(function(reason) {
          console.warn('Failed to fetch info for bug ' + this.props.id
                       + ' (reason: ' + reason + ')');
          this.setState({ loadState: 'load-failed' });
        }.bind(this));
      },
      getBugLink: function() {
        return 'https://bugzilla.mozilla.org/show_bug.cgi?id=' + this.props.id;
      }
    };

    var BugIcon = React.createClass({
      mixins: [BugInfoMixin],
      render: function() {
        if (this.state.loadState != 'load-complete' ||
            this.state.status == 'RESOLVED') {
          return null;
        }

        var titles = {
          'loading': 'loading bug information',
          'load-failed': 'failed to load bug information',
          'load-complete': this.state.summary
                           + ' (' + [ this.state.status,
                                      this.state.resolution ].join(" ").trim()
                           + ')'
        };
        var title = titles[this.state.loadState];
        var className = this.state.loadState == 'load-complete'
                      ? this.state.status.toLowerCase()
                      : this.state.loadState;
        return (<span className={'bug ' + className}><a
          href={this.getBugLink()} title={title}>{this.props.id}</a></span>);
      }
    });

    var BugDetail = React.createClass({
      mixins: [BugInfoMixin],
      render: function() {
        if (this.state.loadState == 'loading') {
          return (
            <li className="loading"><a
              href={this.getBugLink()}>{this.props.id}</a> 
              Loading bug details&hellip;</li>
          );
        }
        if (this.state.loadState == 'load-failed') {
          return (
            <li className="load-failed"><a
              href={this.getBugLink()}>{this.props.id}</a>
              (Failed to load bug details)</li>
          );
        }
        var status =
          [ this.state.status, this.state.resolution ].join(" ").trim();
        return (
          <li className={this.state.status}><a
            href={this.getBugLink()}>{this.props.id} {this.state.summary}</a>
            <span className="bug-status">({status})</span></li>
        );
      }
    });

    $.getJSON('status.json').then(function(objects) {
      var renderObject = function(object) {
        // Massage members array into something nicer
        var members = Object.keys(object.members).map(function(name) {
          var result = object.members[name];
          result.name = name;
          result.interface = object.name;
          return result;
        });

        return <InterfaceBox name={object.name} members={members} />;
      };

      objects.forEach(function(object) {
        React.render(renderObject(object),
                     document.getElementById('interfaces'));
      });

      return bugTracker.fetch();
    }).fail(function(xhr, error) {
      $(document.body).append('Failed to load status.json: ' + error);
    });
  </script>
</html>
