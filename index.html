<!doctype html>
<html lang="en">
  <head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Are we animated yet?</title>
  </head>
  <body role="document">

    <div class="container">
      <h1>Are we animated yet?</h1>
      <p>This page tracks the progress of implementing the <a
      href="http://w3c.github.io/web-animations/">Web Animations API</a>
      in Firefox. The status here refers to the status in the latest <a
      href="https://nightly.mozilla.org/">Firefox Nightly build</a>.
      In Firefox Developer Edition (aka Aurora) you'll see bits and pieces of
      the API, and in beta and release versions you'll see nothing at all
      unless you set <code>dom.animations-api.core.enabled</code> to true.</p>
      <p><a class="btn btn-primary btn-lg"
        href="https://nightly.mozilla.org/" role="button">Firefox
        Nightly &raquo;</a></p>
    </div>
    <div class="container" id="interfaces"></div>
  </body>
  <script src="js/vendor/react.js"></script>
  <script src="js/vendor/JSXTransformer.js"></script>
  <script src="js/vendor/zepto.min.js"></script>
  <script type="text/jsx">
    var pendingBugs = [];

    var InterfaceBox = React.createClass({
      render: function() {
        var specLink =
          'http://w3c.github.io/web-animations/#'
          + this.props.name.toLowerCase();
        return (
          <div className="interface">
            <span className="interface-name"><a
              href={specLink}>{this.props.name}</a></span>
            {
              this.props.members.map(function(member) {
                return <Member key={member.name} {...member} />;
              })
            }
          </div>
        );
      }
    });

    var Member = React.createClass({
      render: function() {
        var specLink =
          [ 'http://w3c.github.io/web-animations/#dom',
            this.props.interface.toLowerCase(),
            this.props.name.toLowerCase() ].join('-');
        return (
          <div className={'member ' + this.props.status}><a
            href={specLink}>{this.props.name}</a>
            {
              this.props.bugs.map(function(bugNum) {
                return <Bug key={'bug-' + bugNum} number={bugNum}
                            member={this.props.name} />;
              }.bind(this))
            }
          </div>
        );
      }
    });

    var Bug = React.createClass({
      getInitialState: function() {
        return { loadState: "loading" };
      },
      getLoadEventName: function() {
        return 'bugs-loaded.' + this.props.member + '.' + this.props.number;
      },
      componentDidMount: function() {
        pendingBugs.push(this.props.number);
        $(document.body).on(this.getLoadEventName(),
          function() { console.log("Bugs loaded!"); });
      },
      componentWillUnmount: function() {
        $(document.body).off(this.getLoadEventName());
      },
      render: function() {
        var bugLink =
          'https://bugzilla.mozilla.org/show_bug.cgi?id=' + this.props.number;
        return (<span className={'bug ' + this.state.loadState}><a
          href={bugLink}>{this.props.number}</a></span>);
      }
    });

    $.getJSON('status.json').then(function(objects) {
      var renderObject = function(object) {
        // Massage members array into something nicer
        var members = Object.keys(object.members).map(function(name) {
          var result = object.members[name];
          result.name = name;
          result.interface = object.name;
          return result;
        });

        return <InterfaceBox name={object.name} members={members} />;
      };

      objects.forEach(function(object) {
        React.render(renderObject(object),
                     document.getElementById('interfaces'));
      });

      fetchBugInfo();
    }).fail(function(xhr, error) {
      $(document.body).append('Failed to load status.json: ' + error);
    });

    function fetchBugInfo() {
      var query = 'https://bugzilla.mozilla.org/rest/bug?id='
                  + pendingBugs.map(Number).join(',')
                  + '&include_fields=id,summary,status,resolution'
                  + ',last_change_time';
      $.getJSON(query).then(function(bugs) {
        pendingBugs = [];
        $(document.body).trigger('bugs-loaded');
      }).fail(function(xhr, error) {
        $(document.body).append('Failed to load bugs: ' + error);
      });
    }
  </script>
</html>
